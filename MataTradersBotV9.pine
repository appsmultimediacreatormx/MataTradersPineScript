//@version=6
indicator("MATA TRADERS BOT v9 - REENTRADA TRAS SL y TP3 EMA34 (Bybit VSL)", overlay=true)

// === Inputs de visualizaci√≥n ===
mostrar_ema13 = input.bool(true, "Mostrar EMA 13")
mostrar_ema34 = input.bool(true, "Mostrar EMA 34")
mostrar_long = input.bool(true, "Mostrar se√±ales LONG")
mostrar_short = input.bool(true, "Mostrar se√±ales SHORT")
mostrar_sl_inicial = input.bool(true, "Mostrar STOP LOSS INICIAL")
mostrar_tp1 = input.bool(true, "Mostrar TP1")
mostrar_sl_entrada = input.bool(true, "Mostrar SL en entrada")
mostrar_tp2 = input.bool(true, "Mostrar TP2")
mostrar_sl_tp1 = input.bool(true, "Mostrar SL TP1")
mostrar_tp3 = input.bool(true, "Mostrar TP3")
mostrar_sl_final = input.bool(true, "Mostrar SL final")

// === C√°lculo de EMAs ===
ema13 = ta.ema(close, 13)
ema34 = ta.ema(close, 34)
ema13_1h = request.security(syminfo.tickerid, "60", ta.ema(close, 13))
ema34_1h = request.security(syminfo.tickerid, "60", ta.ema(close, 34))

tendenciaPrincipalAlcista = ema13_1h > ema34_1h
tendenciaPrincipalBajista = ema13_1h < ema34_1h
cruceAlcista = ta.crossover(ema13, ema34)
cruceBajista = ta.crossunder(ema13, ema34)
cruceAlcistaValidado = cruceAlcista and tendenciaPrincipalAlcista
cruceBajistaValidado = cruceBajista and tendenciaPrincipalBajista

// ------ Variables normales de estrategia ------
var float sl_long = na
var float sl_short = na
var float tp1_long = na
var float tp1_short = na
var float tp2_long = na
var float tp2_short = na
var float tp3_long = na
var float tp3_short = na
var float precio_entrada_long = na
var float precio_entrada_short = na
var int barra_entrada_long = na
var int barra_entrada_short = na
var bool long_activa = false
var bool short_activa = false
var bool tp1_long_mostrado = false
var bool tp1_short_mostrado = false
var bool tp2_long_mostrado = false
var bool tp2_short_mostrado = false
var bool tp3_long_mostrado = false
var bool tp3_short_mostrado = false
var bool sl_long_a_entrada = false
var bool sl_short_a_entrada = false
var bool sl_long_en_tp1 = false
var bool sl_short_en_tp1 = false
var bool sl_long_en_tp3 = false
var bool sl_short_en_tp3 = false

var int conteo_toques_sl_tp1_long = 0
var float last_touch_sl_tp1_long = na
var int conteo_toques_sl_tp1_short = 0
var float last_touch_sl_tp1_short = na
var int conteo_toques_sl_tp3_long = 0
var float last_touch_sl_tp3_long = na
var int conteo_toques_sl_tp3_short = 0
var float last_touch_sl_tp3_short = na

var int conteo_toques_long = 0
var int conteo_toques_short = 0
var float last_touch_long = na
var float last_touch_short = na

// Variables para el SL EMA34 - SEGUNDO TOQUE o PRIMER TOQUE seg√∫n condici√≥n
var int conteo_toques_sl_ema34_long = 0
var float last_touch_sl_ema34_long = na
var int conteo_toques_sl_ema34_short = 0
var float last_touch_sl_ema34_short = na

// Variables para la condici√≥n del 0.2% respecto a EMA13 (modificado)
var bool sl_ema34_primer_toque_long = false
var bool sl_ema34_primer_toque_short = false

// ------ Variables para se√±ales anticipadas y canceladas ------
var bool long_anticipada = false
var int bar_long_anticipada = na
var label label_long_ant = na
var bool long_anticipada_cancelada = false
var float precio_long_ant = na

var bool short_anticipada = false
var int bar_short_anticipada = na
var label label_short_ant = na
var bool short_anticipada_cancelada = false
var float precio_short_ant = na

// --- NUEVAS VARIABLES PARA REENTRADA TRAS SL ---
var bool short_sl_reciente = false
var int bar_short_sl_reciente = na
var bool long_sl_reciente = false
var int bar_long_sl_reciente = na

// --- NUEVAS VARIABLES PARA SL DIN√ÅMICO EN DOBLE TOQUE ---
var float primer_toque_ema34_long = na
var bool esperando_segundo_toque_long = false
var float primer_toque_ema34_short = na
var bool esperando_segundo_toque_short = false

// === Variables para SL din√°mico en SL ENTRADA (break even) y SL TP1 ===
var float primer_toque_break_even_long = na
var bool esperando_caida_break_even_long = false
var float primer_toque_break_even_short = na
var bool esperando_subida_break_even_short = false

var float primer_toque_sl_tp1_long = na
var bool esperando_caida_sl_tp1_long = false
var float primer_toque_sl_tp1_short = na
var bool esperando_subida_sl_tp1_short = false

sl_buffer = 0.2

// === NUEVAS BANDERAS PARA REENTRADA TRAS TP3 Y CRUCE EMA34 ===
var bool esperando_reentrada_tp3_short = false
var bool esperando_reentrada_tp3_long = false

// === Ploteo de EMAs ===
plot(mostrar_ema13 ? ema13 : na, title="EMA 13", color=color.yellow, linewidth=2)
plot(mostrar_ema34 ? ema34 : na, title="EMA 34", color=color.white, linewidth=2)

// ======================
// SE√ëALES ANTICIPADAS Y APERTURA SOLO SI <=0.2% SOBRE EMA13_1H
// ======================

// SHORT
if not short_anticipada and not short_anticipada_cancelada and cruceBajista and tendenciaPrincipalBajista
    float distancia_short = ((ema13_1h - high) / ema13_1h) * 100
    short_anticipada := true
    bar_short_anticipada := bar_index
    precio_short_ant := high
    if mostrar_short
        label_short_ant := label.new(bar_index, high + syminfo.mintick * 30, "SHORT ANT", style=label.style_label_down, color=color.new(color.aqua, 0), textcolor=color.white)
    short_anticipada_cancelada := false
    long_anticipada := false
    long_anticipada_cancelada := false
    if distancia_short <= 0.2
        alert("APERTURA SHORT ANTICIPADA: Precio=" + str.tostring(high) + ", EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

// LONG
if not long_anticipada and not long_anticipada_cancelada and cruceAlcista and tendenciaPrincipalAlcista
    float distancia_long = ((low - ema13_1h) / ema13_1h) * 100
    long_anticipada := true
    bar_long_anticipada := bar_index
    precio_long_ant := low
    if mostrar_long
        label_long_ant := label.new(bar_index, low - syminfo.mintick * 30, "LONG ANT", style=label.style_label_up, color=color.new(color.aqua, 0), textcolor=color.white)
    long_anticipada_cancelada := false
    short_anticipada := false
    short_anticipada_cancelada := false
    if distancia_long <= 0.2
        alert("APERTURA LONG ANTICIPADA: Precio=" + str.tostring(low) + ", EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

// ACTUALIZACI√ìN SL DIN√ÅMICO EN EMA34_1H MIENTRAS NO SE CONFIRMA SE√ëAL REAL
if short_anticipada and not short_activa
    alert("ACTUALIZA SL DINAMICO SHORT, EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)
if long_anticipada and not long_activa
    alert("ACTUALIZA SL DINAMICO LONG, EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

// CANCELACI√ìN DE SE√ëALES ANTICIPADAS Y CIERRE INMEDIATO PARA BYBIT
if long_anticipada and close < ema13
    if not long_anticipada_cancelada
        label.new(bar_index, low - syminfo.mintick * 20, "‚ùå", style=label.style_label_up, color=color.red, textcolor=color.white)
        if not na(label_long_ant)
            label.set_color(label_long_ant, color.gray)
            label.set_textcolor(label_long_ant, color.white)
        long_anticipada_cancelada := true
        alert("CERRAR LONG POR CANCELACION ANTICIPADA", alert.freq_once_per_bar)
    long_anticipada := false

if short_anticipada and close > ema13
    if not short_anticipada_cancelada
        label.new(bar_index, high + syminfo.mintick * 20, "‚ùå", style=label.style_label_down, color=color.red, textcolor=color.white)
        if not na(label_short_ant)
            label.set_color(label_short_ant, color.gray)
            label.set_textcolor(label_short_ant, color.white)
        short_anticipada_cancelada := true
        alert("CERRAR SHORT POR CANCELACION ANTICIPADA", alert.freq_once_per_bar)
    short_anticipada := false

// REENTRADAS (PULLBACK Y TRAS SL) SOLO EN FAVOR DE TENDENCIA PRINCIPAL Y CON EL FILTRO DE DISTANCIA
if short_anticipada_cancelada and not cruceAlcista and tendenciaPrincipalBajista and not esperando_reentrada_tp3_short
    if close < ema13 and not short_anticipada
        float distancia_short = ((ema13_1h - high) / ema13_1h) * 100
        short_anticipada := true
        bar_short_anticipada := bar_index
        precio_short_ant := high
        if mostrar_short
            label_short_ant := label.new(bar_index, high + syminfo.mintick * 30, "SHORT ANT (PULLBACK)", style=label.style_label_down, color=color.new(color.aqua, 0), textcolor=color.white)
        short_anticipada_cancelada := false
        if distancia_short <= 0.2
            alert("APERTURA SHORT ANTICIPADA: Precio=" + str.tostring(high) + ", EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

if long_anticipada_cancelada and not cruceBajista and tendenciaPrincipalAlcista and not esperando_reentrada_tp3_long
    if close > ema13 and not long_anticipada
        float distancia_long = ((low - ema13_1h) / ema13_1h) * 100
        long_anticipada := true
        bar_long_anticipada := bar_index
        precio_long_ant := low
        if mostrar_long
            label_long_ant := label.new(bar_index, low - syminfo.mintick * 30, "LONG ANT (PULLBACK)", style=label.style_label_up, color=color.new(color.aqua, 0), textcolor=color.white)
        long_anticipada_cancelada := false
        if distancia_long <= 0.2
            alert("APERTURA LONG ANTICIPADA: Precio=" + str.tostring(low) + ", EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

if short_sl_reciente and not cruceAlcista and tendenciaPrincipalBajista and not short_anticipada and not short_activa and not esperando_reentrada_tp3_short
    if close < ema13
        float distancia_short = ((ema13_1h - high) / ema13_1h) * 100
        short_anticipada := true
        bar_short_anticipada := bar_index
        precio_short_ant := high
        if mostrar_short
            label_short_ant := label.new(bar_index, high + syminfo.mintick * 30, "SHORT ANT (RE-ENTRY SL)", style=label.style_label_down, color=color.new(color.yellow, 0), textcolor=color.black)
        short_sl_reciente := false
        if distancia_short <= 0.2
            alert("APERTURA SHORT ANTICIPADA: Precio=" + str.tostring(high) + ", EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

if long_sl_reciente and not cruceBajista and tendenciaPrincipalAlcista and not long_anticipada and not long_activa and not esperando_reentrada_tp3_long
    if close > ema13
        float distancia_long = ((low - ema13_1h) / ema13_1h) * 100
        long_anticipada := true
        bar_long_anticipada := bar_index
        precio_long_ant := low
        if mostrar_long
            label_long_ant := label.new(bar_index, low - syminfo.mintick * 30, "LONG ANT (RE-ENTRY SL)", style=label.style_label_up, color=color.new(color.yellow, 0), textcolor=color.black)
        long_sl_reciente := false
        if distancia_long <= 0.2
            alert("APERTURA LONG ANTICIPADA: Precio=" + str.tostring(low) + ", EMA34_1H=" + str.tostring(ema34_1h), alert.freq_once_per_bar)

if esperando_reentrada_tp3_short and not short_anticipada and not short_activa
    if close > ema34 and ema13 <= ema34 and tendenciaPrincipalBajista and not cruceAlcista
        esperando_reentrada_tp3_short := false
        short_anticipada_cancelada := true

if esperando_reentrada_tp3_long and not long_anticipada and not long_activa
    if close < ema34 and ema13 >= ema34 and tendenciaPrincipalAlcista and not cruceBajista
        esperando_reentrada_tp3_long := false
        long_anticipada_cancelada := true

// ----- CONFIRMACI√ìN DE SE√ëALES ANTICIPADAS (entrada real, se√±al roja/verde) -----
if long_anticipada and not long_anticipada_cancelada and bar_index > bar_long_anticipada and not long_activa
    precio_entrada_long := close[1] > open[1] ? open[1] : close[1]
    float distancia_long = ((precio_entrada_long - ema13[1]) / ema13[1]) * 100
    if distancia_long <= 0.2
        sl_long := ema34[1]
        tp1_long := precio_entrada_long * 1.01
        tp2_long := precio_entrada_long * 1.03
        tp3_long := precio_entrada_long * 1.05
        barra_entrada_long := bar_index - 1
        long_activa := true
        short_activa := false
        tp1_long_mostrado := false
        tp2_long_mostrado := false
        tp3_long_mostrado := false
        sl_long_a_entrada := false
        sl_long_en_tp1 := false
        sl_long_en_tp3 := false
        conteo_toques_long := 0
        last_touch_long := na
        conteo_toques_sl_tp1_long := 0
        last_touch_sl_tp1_long := na
        conteo_toques_sl_tp3_long := 0
        last_touch_sl_tp3_long := na
        conteo_toques_sl_ema34_long := 0
        last_touch_sl_ema34_long := na
        float distancia_long_ema34 = ((precio_entrada_long - ema13[1]) / ema13[1]) * 100
        sl_ema34_primer_toque_long := distancia_long_ema34 >= 0.2
        if mostrar_long
            label.new(bar_index - 1, low[1] - syminfo.mintick * 20, "LONG\n" + str.tostring(precio_entrada_long, "#.#####"), style=label.style_label_up, color=color.green, textcolor=color.white)
        if not na(label_long_ant)
            label.set_color(label_long_ant, color.gray)
            label.set_textcolor(label_long_ant, color.white)
        long_anticipada := false
        long_anticipada_cancelada := false
        alert("CONFIRMACION LONG REAL, AJUSTA A TP/SL DE ESTRATEGIA", alert.freq_once_per_bar)

if short_anticipada and not short_anticipada_cancelada and bar_index > bar_short_anticipada and not short_activa
    precio_entrada_short := close[1] < open[1] ? open[1] : close[1]
    float distancia_short = ((ema13[1] - precio_entrada_short) / ema13[1]) * 100
    if distancia_short <= 0.2
        sl_short := ema34[1]
        tp1_short := precio_entrada_short * 0.99
        tp2_short := precio_entrada_short * 0.97
        tp3_short := precio_entrada_short * 0.95
        barra_entrada_short := bar_index - 1
        short_activa := true
        long_activa := false
        tp1_short_mostrado := false
        tp2_short_mostrado := false
        tp3_short_mostrado := false
        sl_short_a_entrada := false
        sl_short_en_tp1 := false
        sl_short_en_tp3 := false
        conteo_toques_short := 0
        last_touch_short := na
        conteo_toques_sl_tp1_short := 0
        last_touch_sl_tp1_short := na
        conteo_toques_sl_tp3_short := 0
        last_touch_sl_tp3_short := na
        conteo_toques_sl_ema34_short := 0
        last_touch_sl_ema34_short := na
        float distancia_short_ema34 = ((ema13[1] - precio_entrada_short) / ema13[1]) * 100
        sl_ema34_primer_toque_short := distancia_short_ema34 >= 0.2
        if mostrar_short
            label.new(bar_index - 1, high[1] + syminfo.mintick * 20, "SHORT\n" + str.tostring(precio_entrada_short, "#.#####"), style=label.style_label_down, color=color.red, textcolor=color.white)
        if not na(label_short_ant)
            label.set_color(label_short_ant, color.gray)
            label.set_textcolor(label_short_ant, color.white)
        short_anticipada := false
        short_anticipada_cancelada := false
        alert("CONFIRMACION SHORT REAL, AJUSTA A TP/SL DE ESTRATEGIA", alert.freq_once_per_bar)

// ----- SL inicial (SL EMA34 - doble toque/primer toque seg√∫n condici√≥n) -----
if long_activa and not sl_long_a_entrada and not sl_long_en_tp1 and not sl_long_en_tp3 and bar_index > barra_entrada_long
    if sl_ema34_primer_toque_long
        if low < ema34
            if mostrar_sl_inicial and mostrar_long
                label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 ‚Üì\n" + str.tostring(ema34, "#.#####"), style=label.style_label_up, color=color.yellow, textcolor=color.black)
            long_activa := false
            conteo_toques_sl_ema34_long := 0
            last_touch_sl_ema34_long := na
            esperando_segundo_toque_long := false
            primer_toque_ema34_long := na
            long_sl_reciente := true
            bar_long_sl_reciente := bar_index
    else
        if low < ema34
            if not esperando_segundo_toque_long
                primer_toque_ema34_long := low
                esperando_segundo_toque_long := true
                conteo_toques_sl_ema34_long := 1
                last_touch_sl_ema34_long := low
            else
                if not na(last_touch_sl_ema34_long) and low < last_touch_sl_ema34_long
                    conteo_toques_sl_ema34_long := conteo_toques_sl_ema34_long + 1
                last_touch_sl_ema34_long := low
                if conteo_toques_sl_ema34_long >= 2
                    if mostrar_sl_inicial and mostrar_long
                        label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 ‚Üì\n" + str.tostring(ema34, "#.#####"), style=label.style_label_up, color=color.yellow, textcolor=color.black)
                    long_activa := false
                    conteo_toques_sl_ema34_long := 0
                    last_touch_sl_ema34_long := na
                    esperando_segundo_toque_long := false
                    primer_toque_ema34_long := na
                    long_sl_reciente := true
                    bar_long_sl_reciente := bar_index
        else
            if esperando_segundo_toque_long and not na(primer_toque_ema34_long)
                float caida_natural = ((primer_toque_ema34_long - low) / primer_toque_ema34_long) * 100
                if caida_natural >= 0.2
                    if mostrar_sl_inicial and mostrar_long
                        label.new(bar_index, low - syminfo.mintick * 40, "üü© SL EMA34 (CA√çDA) ‚Üì\n" + str.tostring(low, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
                    long_activa := false
                    conteo_toques_sl_ema34_long := 0
                    last_touch_sl_ema34_long := na
                    esperando_segundo_toque_long := false
                    primer_toque_ema34_long := na
                    long_sl_reciente := true
                    bar_long_sl_reciente := bar_index

if short_activa and not sl_short_a_entrada and not sl_short_en_tp1 and not sl_short_en_tp3 and bar_index > barra_entrada_short
    if sl_ema34_primer_toque_short
        if high > ema34
            if mostrar_sl_inicial and mostrar_short
                label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 ‚Üë\n" + str.tostring(ema34, "#.#####"), style=label.style_label_down, color=color.yellow, textcolor=color.black)
            short_activa := false
            conteo_toques_sl_ema34_short := 0
            last_touch_sl_ema34_short := na
            esperando_segundo_toque_short := false
            primer_toque_ema34_short := na
            short_sl_reciente := true
            bar_short_sl_reciente := bar_index
    else
        if high > ema34
            if not esperando_segundo_toque_short
                primer_toque_ema34_short := high
                esperando_segundo_toque_short := true
                conteo_toques_sl_ema34_short := 1
                last_touch_sl_ema34_short := high
            else
                if not na(last_touch_sl_ema34_short) and high > last_touch_sl_ema34_short
                    conteo_toques_sl_ema34_short := conteo_toques_sl_ema34_short + 1
                last_touch_sl_ema34_short := high
                if conteo_toques_sl_ema34_short >= 2
                    if mostrar_sl_inicial and mostrar_short
                        label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 ‚Üë\n" + str.tostring(ema34, "#.#####"), style=label.style_label_down, color=color.yellow, textcolor=color.black)
                    short_activa := false
                    conteo_toques_sl_ema34_short := 0
                    last_touch_sl_ema34_short := na
                    esperando_segundo_toque_short := false
                    primer_toque_ema34_short := na
                    short_sl_reciente := true
                    bar_short_sl_reciente := bar_index
        else
            if esperando_segundo_toque_short and not na(primer_toque_ema34_short)
                float subida_natural = ((high - primer_toque_ema34_short) / primer_toque_ema34_short) * 100
                if subida_natural >= 0.2
                    if mostrar_sl_inicial and mostrar_short
                        label.new(bar_index, high + syminfo.mintick * 40, "üü• SL EMA34 (SUBIDA) ‚Üë\n" + str.tostring(high, "#.#####"), style=label.style_label_down, color=color.red, textcolor=color.white)
                    short_activa := false
                    conteo_toques_sl_ema34_short := 0
                    last_touch_sl_ema34_short := na
                    esperando_segundo_toque_short := false
                    primer_toque_ema34_short := na
                    short_sl_reciente := true
                    bar_short_sl_reciente := bar_index

// TP1
if long_activa and not tp1_long_mostrado and high >= tp1_long
    if mostrar_long and mostrar_tp1
        label.new(bar_index, tp1_long + syminfo.mintick * 10, "TP1\n" + str.tostring(tp1_long, "#.#####"), style=label.style_label_down, color=color.green, textcolor=color.white)
    tp1_long_mostrado := true
    sl_long := precio_entrada_long
    sl_long_a_entrada := true

if short_activa and not tp1_short_mostrado and low <= tp1_short
    if mostrar_short and mostrar_tp1
        label.new(bar_index, tp1_short - syminfo.mintick * 10, "TP1\n" + str.tostring(tp1_short, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
    tp1_short_mostrado := true
    sl_short := precio_entrada_short
    sl_short_a_entrada := true

// ---- SL EN ENTRADA post TP1 MODIFICADO (con SL din√°mico 0.2%) ----
if long_activa and sl_long_a_entrada
    if low <= sl_long and not esperando_caida_break_even_long
        primer_toque_break_even_long := low
        esperando_caida_break_even_long := true
    if low <= sl_long and esperando_caida_break_even_long and low < primer_toque_break_even_long
        if mostrar_long and mostrar_sl_entrada
            string sl_label = "üü© SL ENTRADA ‚Üì\n" + str.tostring(sl_long, "#.#####")
            if sl_long == tp1_long
                sl_label := "üü© SL TP1 ‚Üì\n" + str.tostring(sl_long, "#.#####")
            else if sl_long == tp2_long
                sl_label := "üü© SL TP2 ‚Üì\n" + str.tostring(sl_long, "#.#####")
            else if sl_long == tp3_long
                sl_label := "üü© SL TP3 ‚Üì\n" + str.tostring(sl_long, "#.#####")
            label.new(bar_index, low - syminfo.mintick * 40, sl_label, style=label.style_label_up, color=color.orange, textcolor=color.white)
        long_activa := false
        conteo_toques_long := 0
        last_touch_long := na
        primer_toque_break_even_long := na
        esperando_caida_break_even_long := false
    if esperando_caida_break_even_long and not na(primer_toque_break_even_long)
        float caida_break_even = ((primer_toque_break_even_long - low) / primer_toque_break_even_long) * 100
        if caida_break_even >= sl_buffer
            if mostrar_long and mostrar_sl_entrada
                label.new(bar_index, low - syminfo.mintick * 40, "üüß SL -0.2% BAJO ENTRADA ‚Üì\n" + str.tostring(low, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
            long_activa := false
            conteo_toques_long := 0
            last_touch_long := na
            primer_toque_break_even_long := na
            esperando_caida_break_even_long := false
    if close < ema34
        if mostrar_long and mostrar_sl_entrada
            label.new(bar_index, low - syminfo.mintick * 40, "üüß SL POST TP1 ‚Üì\n" + str.tostring(ema34, "#.#####"), style=label.style_label_up, color=color.orange, textcolor=color.white)
        long_activa := false
        conteo_toques_long := 0
        last_touch_long := na
        primer_toque_break_even_long := na
        esperando_caida_break_even_long := false

if short_activa and sl_short_a_entrada
    if high >= sl_short and not esperando_subida_break_even_short
        primer_toque_break_even_short := high
        esperando_subida_break_even_short := true
    if high >= sl_short and esperando_subida_break_even_short and high > primer_toque_break_even_short
        if mostrar_short and mostrar_sl_entrada
            string sl_label = "üü• SL ENTRADA ‚Üë\n" + str.tostring(sl_short, "#.#####")
            if sl_short == tp1_short
                sl_label := "üü• SL TP1 ‚Üë\n" + str.tostring(sl_short, "#.#####")
            else if sl_short == tp2_short
                sl_label := "üü• SL TP2 ‚Üë\n" + str.tostring(sl_short, "#.#####")
            else if sl_short == tp3_short
                sl_label := "üü• SL TP3 ‚Üë\n" + str.tostring(sl_short, "#.#####")
            label.new(bar_index, high + syminfo.mintick * 40, sl_label, style=label.style_label_down, color=color.orange, textcolor=color.white)
        short_activa := false
        conteo_toques_short := 0
        last_touch_short := na
        primer_toque_break_even_short := na
        esperando_subida_break_even_short := false
    if esperando_subida_break_even_short and not na(primer_toque_break_even_short)
        float subida_break_even = ((high - primer_toque_break_even_short) / primer_toque_break_even_short) * 100
        if subida_break_even >= sl_buffer
            if mostrar_short and mostrar_sl_entrada
                label.new(bar_index, high + syminfo.mintick * 40, "üüß SL +0.2% SOBRE ENTRADA ‚Üë\n" + str.tostring(high, "#.#####"), style=label.style_label_down, color=color.red, textcolor=color.white)
            short_activa := false
            conteo_toques_short := 0
            last_touch_short := na
            primer_toque_break_even_short := na
            esperando_subida_break_even_short := false
    if close > ema34
        if mostrar_short and mostrar_sl_entrada
            label.new(bar_index, high + syminfo.mintick * 40, "üüß SL POST TP1 ‚Üë\n" + str.tostring(ema34, "#.#####"), style=label.style_label_down, color=color.orange, textcolor=color.white)
        short_activa := false
        conteo_toques_short := 0
        last_touch_short := na
        primer_toque_break_even_short := na
        esperando_subida_break_even_short := false

// TP2
if long_activa and not tp2_long_mostrado and high >= tp2_long
    if mostrar_long and mostrar_tp2
        label.new(bar_index, tp2_long + syminfo.mintick * 10, "TP2\n" + str.tostring(tp2_long, "#.#####"), style=label.style_label_down, color=color.green, textcolor=color.white)
    tp2_long_mostrado := true
    sl_long := tp1_long
    sl_long_en_tp1 := true
    conteo_toques_sl_tp1_long := 0
    last_touch_sl_tp1_long := na
    // Reset SL din√°mico TP1
    primer_toque_sl_tp1_long := na
    esperando_caida_sl_tp1_long := false

if short_activa and not tp2_short_mostrado and low <= tp2_short
    if mostrar_short and mostrar_tp2
        label.new(bar_index, tp2_short - syminfo.mintick * 10, "TP2\n" + str.tostring(tp2_short, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
    tp2_short_mostrado := true
    sl_short := tp1_short
    sl_short_en_tp1 := true
    conteo_toques_sl_tp1_short := 0
    last_touch_sl_tp1_short := na
    // Reset SL din√°mico TP1
    primer_toque_sl_tp1_short := na
    esperando_subida_sl_tp1_short := false

// SL TP1 con l√≥gica de doble toque y SL din√°mico 0.2%
if long_activa and sl_long_en_tp1
    if low <= sl_long and not esperando_caida_sl_tp1_long
        primer_toque_sl_tp1_long := low
        esperando_caida_sl_tp1_long := true
    if low <= sl_long and esperando_caida_sl_tp1_long and low < primer_toque_sl_tp1_long
        if mostrar_long and mostrar_sl_tp1
            label.new(bar_index, low - syminfo.mintick * 40, "üü© SL TP1 ‚Üì\n" + str.tostring(sl_long, "#.#####"), style=label.style_label_up, color=color.orange, textcolor=color.white)
        long_activa := false
        conteo_toques_sl_tp1_long := 0
        last_touch_sl_tp1_long := na
        primer_toque_sl_tp1_long := na
        esperando_caida_sl_tp1_long := false
    if esperando_caida_sl_tp1_long and not na(primer_toque_sl_tp1_long)
        float caida_tp1 = ((primer_toque_sl_tp1_long - low) / primer_toque_sl_tp1_long) * 100
        if caida_tp1 >= sl_buffer
            if mostrar_long and mostrar_sl_tp1
                label.new(bar_index, low - syminfo.mintick * 40, "üüß SL TP1 -0.2% ‚Üì\n" + str.tostring(low, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
            long_activa := false
            conteo_toques_sl_tp1_long := 0
            last_touch_sl_tp1_long := na
            primer_toque_sl_tp1_long := na
            esperando_caida_sl_tp1_long := false
    if close < ema34
        if mostrar_long and mostrar_sl_tp1
            label.new(bar_index, low - syminfo.mintick * 40, "üüß SL TP1 EMA34 ‚Üì\n" + str.tostring(ema34, "#.#####"), style=label.style_label_up, color=color.orange, textcolor=color.white)
        long_activa := false
        conteo_toques_sl_tp1_long := 0
        last_touch_sl_tp1_long := na
        primer_toque_sl_tp1_long := na
        esperando_caida_sl_tp1_long := false

if short_activa and sl_short_en_tp1
    if high >= sl_short and not esperando_subida_sl_tp1_short
        primer_toque_sl_tp1_short := high
        esperando_subida_sl_tp1_short := true
    if high >= sl_short and esperando_subida_sl_tp1_short and high > primer_toque_sl_tp1_short
        if mostrar_short and mostrar_sl_tp1
            label.new(bar_index, high + syminfo.mintick * 40, "üü• SL TP1 ‚Üë\n" + str.tostring(sl_short, "#.#####"), style=label.style_label_down, color=color.orange, textcolor=color.white)
        short_activa := false
        conteo_toques_sl_tp1_short := 0
        last_touch_sl_tp1_short := na
        primer_toque_sl_tp1_short := na
        esperando_subida_sl_tp1_short := false
    if esperando_subida_sl_tp1_short and not na(primer_toque_sl_tp1_short)
        float subida_tp1 = ((high - primer_toque_sl_tp1_short) / primer_toque_sl_tp1_short) * 100
        if subida_tp1 >= sl_buffer
            if mostrar_short and mostrar_sl_tp1
                label.new(bar_index, high + syminfo.mintick * 40, "üüß SL TP1 +0.2% ‚Üë\n" + str.tostring(high, "#.#####"), style=label.style_label_down, color=color.red, textcolor=color.white)
            short_activa := false
            conteo_toques_sl_tp1_short := 0
            last_touch_sl_tp1_short := na
            primer_toque_sl_tp1_short := na
            esperando_subida_sl_tp1_short := false
    if close > ema34
        if mostrar_short and mostrar_sl_tp1
            label.new(bar_index, high + syminfo.mintick * 40, "üüß SL TP1 EMA34 ‚Üë\n" + str.tostring(ema34, "#.#####"), style=label.style_label_down, color=color.orange, textcolor=color.white)
        short_activa := false
        conteo_toques_sl_tp1_short := 0
        last_touch_sl_tp1_short := na
        primer_toque_sl_tp1_short := na
        esperando_subida_sl_tp1_short := false

// TP3 (CIERRA LA OPERACI√ìN - NO PERMITE SL FINAL)
if long_activa and not tp3_long_mostrado and high >= tp3_long
    if mostrar_long and mostrar_tp3
        label.new(bar_index, tp3_long + syminfo.mintick * 10, "TP3 TODOS LOS TARGETS CUMPLIDOS\n" + str.tostring(tp3_long, "#.#####"), style=label.style_label_down, color=color.green, textcolor=color.white)
    tp3_long_mostrado := true
    sl_long := tp3_long
    sl_long_en_tp3 := true
    conteo_toques_sl_tp3_long := 0
    last_touch_sl_tp3_long := na
    long_activa := false // CIERRE AUTOM√ÅTICO AL TP3
    esperando_reentrada_tp3_long := true // ACTIVAR BANDERA DE ESPERA

if short_activa and not tp3_short_mostrado and low <= tp3_short
    if mostrar_short and mostrar_tp3
        label.new(bar_index, tp3_short - syminfo.mintick * 10, "TP3 TODOS LOS TARGETS CUMPLIDOS\n" + str.tostring(tp3_short, "#.#####"), style=label.style_label_up, color=color.red, textcolor=color.white)
    tp3_short_mostrado := true
    sl_short := tp3_short
    sl_short_en_tp3 := true
    conteo_toques_sl_tp3_short := 0
    last_touch_sl_tp3_short := na
    short_activa := false // CIERRE AUTOM√ÅTICO AL TP3
    esperando_reentrada_tp3_short := true // ACTIVAR BANDERA DE ESPERA

// SL final (SL TP3) con l√≥gica de doble toque (fondo naranja, emoji cuadrado verde/rojo)
if long_activa and sl_long_en_tp3
    if low <= sl_long
        if not na(last_touch_sl_tp3_long) and low < last_touch_sl_tp3_long
            conteo_toques_sl_tp3_long := conteo_toques_sl_tp3_long + 1
        last_touch_sl_tp3_long := low
    if conteo_toques_sl_tp3_long >= 2
        if mostrar_long and mostrar_sl_final
            label.new(bar_index, low - syminfo.mintick * 40, "üü© SL FINAL ‚Üì\n" + str.tostring(sl_long, "#.#####"), style=label.style_label_up, color=color.orange, textcolor=color.white)
        long_activa := false
        conteo_toques_sl_tp3_long := 0
        last_touch_sl_tp3_long := na

if short_activa and sl_short_en_tp3
    if high >= sl_short
        if not na(last_touch_sl_tp3_short) and high > last_touch_sl_tp3_short
            conteo_toques_sl_tp3_short := conteo_toques_sl_tp3_short + 1
        last_touch_sl_tp3_short := high
    if conteo_toques_sl_tp3_short >= 2
        if mostrar_short and mostrar_sl_final
            label.new(bar_index, high + syminfo.mintick * 40, "üü• SL FINAL ‚Üë\n" + str.tostring(sl_short, "#.#####"), style=label.style_label_down, color=color.orange, textcolor=color.white)
        short_activa := false
        conteo_toques_sl_tp3_short := 0
        last_touch_sl_tp3_short := na

alertcondition(cruceAlcistaValidado, title="Alerta LONG", message="LONG - Entrada: {{open}} o {{close}} - TP1: {{open * 1.01}} - TP2: {{open * 1.03}} - TP3: {{open * 1.05}}")
alertcondition(cruceBajistaValidado, title="Alerta SHORT", message="SHORT - Entrada: {{close}} o {{open}} - TP1: {{close * 0.99}} - TP2: {{close * 0.97}} - TP3: {{close * 0.95}}")
